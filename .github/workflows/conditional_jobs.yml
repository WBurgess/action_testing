name: Conditional Jobs

on:
  pull_request_review:
    types: [ submitted ]

  workflow_dispatch:

jobs:
  debug:
    name: Debug
    runs-on: ubuntu-latest
    outputs:
      truthy-value: ${{ steps.output-truth.outputs.truthy-value }}
    steps:
      - name: 'head.ref'
        run: 'echo ${{ github.event.pull_request.head.ref }}'
      - name: 'base.ref'
        run: 'echo ${{ github.event.pull_request.base.ref }}'
      - name: 'github.event_name'
        run: 'echo ${{ github.event_name}}'
      - name: 'for conditional testing'
        id: output-truth
        run: 'echo "truthy-value=true" >> $GITHUB_OUTPUT'


  deploy-1:
    name: Deploy One
    needs: [ debug ]
    runs-on: ubuntu-latest
    outputs:
      deploy-success: ${{ steps.success-output.outputs.deploy-success }}
    steps:
      - name: Start
        run: echo "Start"

      - name: Finish
        id: success-output
        run: 'echo "deploy-success=true" >> $GITHUB_OUTPUT'

  deploy-2:
    name: Deply Two
    needs: [ debug ]
    runs-on: ubuntu-latest
    outputs:
      deploy-success: ${{ steps.success-output.outputs.deploy-success }}
    steps:
      - name: Start
        run: echo "Start"

      - name: Finish
        id: success-output
        run: 'echo "deploy-success=true" >> $GITHUB_OUTPUT'

  deploy-fail:
    name: Deply Fail
    needs: [ debug ]
    runs-on: ubuntu-latest
    outputs:
      deploy-success: ${{ steps.success-output.outputs.deploy-success }}
    steps:
      - name: Start
        run: exit 1

      - name: Finish
        id: success-output
        run: 'echo "deploy-success=true" >> $GITHUB_OUTPUT'

  tests-no-needs:
    name: Test no needs statement dep 1 and 2
    # needs: [ deploy-1, deploy-2 ]
    if: ${{ needs.deploy-1.outputs.deploy-success == 'true' || needs.deploy-2.outputs.deploy-success == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Tests ran
        run: 'echo These dont run because of no needs dependency'

  tests-needs:
    name: Test with needs dep 1 and 2
    needs: [ deploy-1, deploy-2 ]
    if: ${{ needs.deploy-1.outputs.deploy-success == 'true' || needs.deploy-2.outputs.deploy-success == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Tests ran
        run: 'echo Tests ran!'

  tests-needs-fail-no-run:
    name: Test no always dep 1 and fail
    needs: [ deploy-1, deploy-fail ]
    if: ${{ needs.deploy-1.outputs.deploy-success == 'true' || needs.deploy-2.outputs.deploy-success == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Tests ran
        run: 'echo Tests did not run because of no always'

  tests-needs-fail:
    name: Test always dep 1 and fail
    needs: [ deploy-1, deploy-fail ]
    if: ${{ always() && (needs.deploy-1.outputs.deploy-success == 'true' || needs.deploy-2.outputs.deploy-success == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - name: Tests ran
        run: 'echo Tests ran despite failure because of always'

  tests-needs-fail-second-false:
    name: Test always dep 1, fail, second false
    needs: [ deploy-1, deploy-fail ]
    if: ${{ always() && (needs.deploy-1.outputs.deploy-success == 'true' || needs.deploy-1.outputs.deploy-success == 'false') }}
    runs-on: ubuntu-latest
    steps:
      - name: Tests ran
        run: 'echo Tests ran despite failure because of always'